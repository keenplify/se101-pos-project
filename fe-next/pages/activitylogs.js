import Head from "next/head";
import { Pagination, Table, InputGroup, FormControl } from "react-bootstrap";
import { AiOutlineSearch } from "react-icons/ai";
import { Container } from "react-bootstrap";
import { NavBar } from "../components/navbar";
import { Footer } from "../components/footer";
import { AuthenticateEmployee } from "../helpers/AuthenticateEmployee";
import { LogsQueries } from "../queries/logs";
import { useEffect, useState } from "react";
import { useDebounce } from "use-debounce";

export default function ActivityLogs({ token, _logs, employee }) {
  const [logs, setLogs] = useState(_logs);
  const [pageCount, setPageCount] = useState(_logs.totalCount % 10);
  const [currentPageNumber, setCurrentPageNumber] = useState(1);
  const [keyword, setKeyword] = useState("");
  const [debouncedKeyword] = useDebounce(keyword, 1000); // Wait 1000 before searching (debounced search)
  
  useEffect(()=> {
    if (debouncedKeyword.length > 0) {
      //Get data from search then set it as logs state
      LogsQueries.getAllPaginate(token, 10, {keyword: debouncedKeyword}).then((res) => {
        if (res.data?.logs) {
          setLogs(res.data.logs);
          setCurrentPageNumber(1);
          setPageCount(Math.ceil(res.data.logs.totalCount / 10));
        }
      })
    } else {
      setLogs(_logs);
      setCurrentPageNumber(1);
      setPageCount(Math.ceil(_logs.totalCount / 10));

    }
  }, [debouncedKeyword])

  return (
    <>
      <>
        <Head>
          <title>Vaperous M4ster - POS Website</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/img/Logo.jpg" />
        </Head>
        <NavBar employee={employee} token={token}></NavBar>

        <div
        className="mt-3 mb-2 text-center"
        style={{ width: "100%"}}
      >
        <label
          className="text-center "
          style={{
            fontSize: "30px",
            fontWeight: "bold",
            fontFamily: 'Roboto',
          }}
        >
         ACTIVITY LOGS{" "}
        </label>
          </div>
        <Container className="col-6 mb-3">
      <div className="d-flex p-1">
          <InputGroup >
            <InputGroup.Text id="basic-addon1">
              <AiOutlineSearch></AiOutlineSearch>
            </InputGroup.Text>
            <FormControl
              placeholder="Search"
              aria-label="Search"
              type="search"
              value={keyword}
              onChange={(e) => setKeyword(e.target.value)}
            />
          </InputGroup>
          </div>
          </Container>
          
        <Container>
          <Table striped bordered hover variant="light">
            <thead>
              <tr>
                <th>ID</th>
                <th>DATE CREATED</th>
                <th>CREATED BY</th>
                <th>DESCRIPTION</th>
              </tr>
            </thead>
            <tbody>
              {logs.edges.map((edge, key) => (
                <tr key={key}>
                  <td>{edge.node.id}</td>
                  <td>{new Date(edge.node.createdAt).toLocaleString()}</td>
                  <td>
                    {edge.node.employee.firstName} {edge.node.employee.lastName}
                  </td>
                  <td>{edge.node.description}</td>
                </tr>
              ))}
            </tbody>
          </Table>
          <Pagination className="d-flex justify-content-center text-decoration-none list-unstyled">
            <Pagination.Prev
              onClick={() => {
                if (currentPageNumber == 1 && !logs.pageInfo.hasPreviousPage) return;

                LogsQueries.getAllPaginate(token, 10, {
                  before: logs.pageInfo.startCursor,
                  keyword: keyword ? keyword : null
                })
                  .then((res) => {
                    setLogs(res.data.logs);
                    setCurrentPageNumber(currentPageNumber - 1);
                    setPageCount(Math.ceil(res.data.logs.totalCount / 10));
                  })
                  .catch((err) => console.log(err.response));

              }}
            />
            {Array.from(Array(pageCount)).map((_, key) => (
              <Pagination.Item
                key={key}
                active={
                  Number.parseInt(currentPageNumber) == Number.parseInt(key + 1)
                }
              >
                {key + 1}
              </Pagination.Item>
            ))}
            <Pagination.Next
              onClick={() => {
                if (currentPageNumber == pageCount && !logs.pageInfo.hasNextPage) return;

                LogsQueries.getAllPaginate(token, 10, {
                  after: logs.pageInfo.endCursor,
                  keyword: keyword ? keyword : null
                })
                  .then((res) => {
                    setLogs(res.data.logs);
                    setCurrentPageNumber(currentPageNumber + 1);
                    setPageCount(Math.ceil(res.data.logs.totalCount / 10));
                  })
                  .catch((err) => console.log(err.response));
              }}
            />
          </Pagination>
        </Container>
      </>
      <Footer></Footer>
    </>
  );
}

export async function getServerSideProps(context) {
  const employee = await AuthenticateEmployee(context);

  if (employee.props.token) {
    const data = (await LogsQueries.getAllPaginate(employee.props.token, 10))
      .data;

    return {
      props: {
        ...employee.props,
        _logs: data.logs,
      },
    };
  }

  return {
    props: {
      ...employee.props,
    },
  };
}
